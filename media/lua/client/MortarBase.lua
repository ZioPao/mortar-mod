--[[⠀
----------------------------------------------------------------------------------------------------------------------------⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀                       ⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⣀⣀⣀⣀⣀⣀⣰⣦⣀⣀⠀⠠⠄⠄⠠⠀⠀⢀⣠⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣾⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣶⡿⢿⣦⠀⠀⠀⠀⠀⠀⠀⢀⡷⠀⠀⠀⠀⠀⣀⠀⠀⠀⠀⠀⣩⡿⠋⠙⠉⢩⡿⠟⠀⠀⠀⠀⠀⠀⢀⣶⣾⠟⠋⠛⣿⣷⡄⠀⠀⠀⠀⠀⣴⣿⠂⠀⠀⣼⡿⠀⠀⠀⠀⠀⠀⢀⣠⡴⠶⣤⠀⠀⠀⠀⠀⠀⠀⠀⣠⣴⠦⠤⣤⣤⣀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⡿⠋⠀⢸⠏⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⢠⡇⠀⠀⠀⢠⣾⠋⠀⠀⠀⠀⣸⠀⠀⠀⠀⠀⠀⠀⢠⣿⠋⠀⠀⠀⠀⠛⠛⠁⠀⠀⠀⢀⣾⣿⠏⠀⠀⢀⡿⠃⠀⠀⠀⠀⠀⠶⠋⠁⢀⣰⠟⠀⠀⠀⠀⠀⠀⠀⣹⣿⠀⠀⠀⠀⣨⣿⠇⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⣾⡟⢀⣠⣤⣴⣶⠆⠀⠀⠀⠀⠀⢰⠃⠀⠀⠀⠀⠀⣾⠀⠀⠀⣰⣿⠃⠀⠀⠀⠀⠀⣿⡀⠀⠀⠀⠀⠀⢀⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣸⣿⠋⠀⠀⢀⡾⠁⠀⠀⠀⠀⠀⠀⠀⣠⣶⣯⣅⡀⠀⠀⠀⠀⠀⠀⠀⣿⡇⢀⣠⠴⠞⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣸⡟⠀⠛⠉⣠⣾⠃⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⠀⢿⣤⡴⢺⢻⠃⠀⠀⠀⠀⠀⢸⡿⠁⠀⠀⠀⠀⠀⠀⢿⠀⠀⠀⠀⢀⣤⠀⠀⠀⠀⠀⢀⣿⣇⡤⠤⢤⣾⣤⣄⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⢻⡆⠀⠀⠀⠀⠀⣿⣯⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⣿⠃⠀⠀⢀⣼⠇⠀⠀⠀⠀⠀⠀⣰⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢂⠇⠀⠀⠀⠀⠀⠀⣾⡅⠀⠀⠀⠀⠀⠀⠀⢸⣧⡀⠀⠀⣼⠇⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠐⡇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠃⠀⠀⠀⠀⠀⢰⡏⠘⣦⠀⠀⠀⠀⡀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠘⢧⣤⡶⠟⢻⠀⠀⠀⠀⠀⠀⢠⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⢘⠏⠀⠀⠀⠀⠀⠀⢰⣿⡄⠀⠀⠀⠀⠀⠀⠀⠀⠙⠿⣶⡾⠋⠀⠀⠀⠀⠀⠀⢸⡟⠀⠀⠀⢰⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣀⠞⠁⠀⠀⠀⠀⠀⠀⠁⠀⠈⠙⠂⠔⠊⠁⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣼⠀⠀⠀⠀⠀⢀⣿⣤⠶⠒⠒⠁⠀⠀⠀⠀⢠⠏⠀⠀⠀⠀⠀⠀⠀⠀⠈⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠉⠀⠀⠀⠀⢸⠀⠀⠀⠀⠀⠀⠀⠀⠀⠄⠐⠊⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀

----------------------------------------------------------------------------------------------------------------------------
⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀
Please contact me if you need to hire someone to do mods or other design related tasks
https://steamcommunity.com/id/glytch3r/myworkshopfiles/
https://www.glytch3r.com
https://ko-fi.com/glytch3r
Discord: Glytch3r#2892

Join Glytch3r Mods Discord Server:
https://discord.gg/2skchrKrDv 
----------------------------------------------------------------------------------------------------------------------------
--]]

-- TODO Add Mortar spawning logic
-- TODO Add recipes?
-- TODO Add check for higher z



Mortar = {}
Mortar.directions = {
    ["N"] = {0, -1},
    ["NE"] = {math.sqrt(2) / 2, -math.sqrt(2) / 2},
    ["E"] = {1, 0},
    ["SE"] = {math.sqrt(2) / 2, math.sqrt(2) / 2},
    ["S"] = {0, 1},
    ["SW"] = {-math.sqrt(2) / 2, math.sqrt(2) / 2},
    ["W"] = {-1, 0},
    ["NW"] = {-math.sqrt(2) / 2, -math.sqrt(2) / 2}
}
Mortar.distMin = 4
Mortar.distMax = 12
Mortar.distSteps = 2
Mortar.rad = SandboxVars.Mortar.Radius or 8





function Mortar.init()

    print("Mortar: Initializing")


    local pl = getPlayer()
    if not pl:getModData()['mortarDistance'] then
        pl:getModData()['mortarDistance'] = SandboxVars.Mortar.Radius or 8
    end


end
Events.OnGameStart.Add(Mortar.init)


Mortar.SpawnDebris = function(square)
    -- the tile starts at 0 and ends 64 -8 (8  mortar tiles)
    local dug = IsoObject.new(square, "mortar_" .. ZombRand(63)-8, "", false) 
    square:AddTileObject(dug)
    if isClient() then
        dug:transmitCompleteItemToServer()
    end
    ISInventoryPage.renderDirty = true
end
Mortar.roll = function(chance)
    local roll = ZombRand(1, 101);
    if roll <= chance then
        return true
    end
end
Mortar.GenGroundZero = function(bommX, bommY, bommZ, radius)
    local cell = getCell()
    local playerObj = getSpecificPlayer(0)
    playerObj:startMuzzleFlash()
    for x = bommX - radius, bommX + radius + 1 do
        for y = bommY - radius, bommY + radius + 1 do
            if IsoUtils.DistanceTo(bommX, bommY, x + 0.5, y + 0.5) <= radius then
                local sq = cell:getGridSquare(x, y, bommZ)
                local Xtype = 'addFireOnSquare'
                if Mortar.roll(20) then
                    Xtype = 'addSmokeOnSquare'
                end
                if sq:Is(IsoFlagType.burning) then 
                    sq:getModData()['mortarHit'] = true

                    -- TODO OnTIck is overkill imo -- i dont know what to do
                    Events.OnTick.Add(function() 
                        if sq:getModData()['mortarHit'] and not sq:Is(IsoFlagType.burning)  then 
                            sq:getModData()['mortarHit'] = nil
                        end
                    end)

                end
                if Mortar.roll(60) then
                    local args = {
                        x = x,
                        y = y,
                        z = bommZ
                    }
                    sendClientCommand(playerObj, 'object', Xtype, args)
                end
                chance = 40
                if Mortar.roll(chance) then
                    Mortar.SpawnDebris(sq)
                end

                -- Kill whatever thing is in the square
                local entities = sq:getMovingObjects()

                if entities then
                    for i = entities:size(), 1, -1 do
                        local entity = entities:get(i - 1)
                        if instanceof(entity, "IsoZombie") or instanceof(entity, "IsoPlayer") then
                            if not entity:isGodMod() then
                                entity:Kill(entity)
                            end
                        end
                    end
                end




            end
        end
    end
end
Mortar.ExecuteFire = function(operator, rad, dist)
    local nx = Mortar.directions[tostring(Mortar.spotter:getDir())][1];
    local ny = Mortar.directions[tostring(Mortar.spotter:getDir())][2]
    local bommX = math.floor(operator:getX() + (nx * dist))
    local bommY = math.floor(operator:getY() + (ny * dist))
    local bommZ = operator:getZ()
    -- TODO add a checker and setter for z trajectory based on the highest floor available
    local trajectory = getCell():getGridSquare(bommX, bommY, bommZ)
    local Xtype = 'addExplosionOnSquare'
    local finalRad = ZombRand(3, rad)
    Mortar.GenGroundZero(bommX, bommY, bommZ, finalRad)
end


Mortar.StartFiring = function(_, rad, dist)
    local pl = getPlayer()
    print("Mortar: Trying to fire")
    -- SP or when there's no need for a spotter
    if not isServer() and not isClient() or not SandboxVars.Mortar.NecessarySpotter then -- i change the default to false
        print("SP or no Necessary Spotter")
        Mortar.spotter = pl
        Mortar.ExecuteFire(pl, rad, dist)
    else
        if Mortar.spotter == nil then
            pl:Say("I don't have a spotter right now")
            return
        end
        if Mortar.CheckSpotterForWalkieTalkie(Mortar.spotter) then
            -- TODO Add a check for visibility -- probably a sandbox will do
            Mortar.ExecuteFire(pl, rad, dist)
        else
            pl:Say("My spotter has no Walkie Talkie on their hand")
            Mortar.spotter = nil
        end

    end


end

-----------------------------------------------------------


-- Disassemble and returns the item to the player inventory
Mortar.Disassemble = function()

end